# Adding Structure to the Timeline (Part One)

Today we will cover:

1. Setup and recap (using multiple trials in a timeline)
2. Grouping and repeating trials
3. Conditional trials
4. Looping trials
5. Dynamic trials

## Setup and Recap

Last lab, we created a simple timeline with multiple trials. Let's pick up there. Create a new file called experiment.html and add the following code:

```html
<!DOCTYPE html>
<html>
  
  <head>
    <title>My jsPsych experiment</title>
    <!-- import jsPsych -->
    <script src="https://unpkg.com/jspsych@7.0.0"></script>

    <!-- import  the jsPsych styling file -->
    <link href="https://unpkg.com/jspsych@7.3.1/css/jspsych.css" rel="stylesheet" type="text/css" />
    
    <!-- import some plugins -->
    <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.0.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-instructions@1.0.0" type="text/javascript"></script>
    <script src="https://unpkg.com/@jspsych/plugin-image-keyboard-response@1.1.2"></script>
  </head>
  
  <body>

    <!-- jsPsych code goes here -->
    <script type="text/javascript">

      // initialize jsPsych
      var jsPsych = initJsPsych();

      // setup a timeline object 
      var timeline = [];

      // create a an instruction trial using the jsPsychInstructions plugin
      var instructionsTrial = {
        type: jsPsychInstructions,
        pages: [
          'Welcome to the experiment. Click next to begin.',
          'This is the second page of instructions.',
          'On each trial, you will be shown an image and asked to press one of two keys. Please click Continue to begin.'
        ],
        button_label_next: "Continue",
        button_label_previous: "Go Back",
        show_clickable_nav: true
      }
    
      var imageTrial = {
          type: jsPsychImageKeyboardResponse,
          stimulus: '290Q-DALL-E.png',
          stimulus_height: 200,
          choices: ['a', 'h'],
          prompt: "<p>Is this image generated by an AI model?<br>Press the 'a' key if you think it was generated by an AI model.<br>Press the 'h' key if you think it was created by a human.</p>",
      };
    
      // add both trials to the timeline
      timeline.push(instructionsTrial)
      timeline.push(imageTrial)

      // run the experiment
      jsPsych.run(timeline);

    </script>
  </body>

</html>
```

## Grouping and Repeating trials

In the code above, we have some instructions and then a single `jsPsychImageKeyboardResponse` trial. We could add more trials individually to the timeline, but often it is useful to create groups of trials, and then re-use those groups of trials multiple times. 

For example, we may wish to present a fixation cross before presnting a stimulus briefly and then collecting a response. We might want to repeat this trial structure multiple times. Here's one way we could achieve this kind of grouping and repeating using jsPsych.

First, let's create a fixation cross trial. This trial displays a trial stimulus (`+`) for `500`ms, and does not allow paarticipants to move forward by pressing a key (`NO_KEYS`).

```js
var fixationCross = {
    type: jsPsychHtmlKeyboardResponse,
    stimulus: '+',
    choices: "NO_KEYS",
    trial_duration: 500
}
```

Second, let's create a stimulus presentation trial using the `jsPsychImageKeyboardResponse` plugin. This trial presents a stimulus for `2.5` seconds.

```js
var stimulusTrial = {
    type: jsPsychImageKeyboardResponse,
    stimulus: 'img-1.png',
    choices: "NO_KEYS",
    trial_duration: 2500
}
```

Finally, we can create a feedback trial using `jsPsychHtmlKeyboardResponse`.

```js
var feedbackTrial = {
	type: jsPsychHtmlKeyboardResponse,
    stimulus: 'The correct response to this stimulus is: h<br><hr>Please press h to proced.',
    choices: ["h"],
    stimulus_width: 250,
}
```

We can group these trials togethor into a single object (`trainingProcedure`) that has it's own timeline, and can be repeated any number of times (by specifying the `repetitions` property of the object). Here's an example repeating the trial structure three times:

```js
var trainingProcedure = {
	timeline: [fixationCross, stimulusTrial, feedbackTrial],
	repetitions: 3
}
```

Let's add these trials into our HTML page, replacing the image trial from before. Our page as a whole should look someething like this now:


```html
<!DOCTYPE html>
<html>
  
  <head>
    <title>My jsPsych experiment</title>
    <!-- import jsPsych -->
    <script src="https://unpkg.com/jspsych@7.0.0"></script>

    <!-- import  the jsPsych styling file -->
    <link href="https://unpkg.com/jspsych@7.3.1/css/jspsych.css" rel="stylesheet" type="text/css" />
    
    <!-- import some plugins -->
    <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.0.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-instructions@1.0.0" type="text/javascript"></script>
    <script src="https://unpkg.com/@jspsych/plugin-image-keyboard-response@1.1.2"></script>
  </head>
  
  <body>

    <!-- jsPsych code goes here -->
    <script type="text/javascript">

      // initialize jsPsych
      var jsPsych = initJsPsych();

      // setup a timeline object 
      var timeline = [];

      // create a an instruction trial using the jsPsychInstructions plugin
      var instructionsTrial = {
        type: jsPsychInstructions,
        pages: [
          'Welcome to the experiment. Click next to begin.',
          'This is the second page of instructions.',
          'On each trial, you will be shown an image and asked to press one of two keys. Please click Continue to begin.'
        ],
        button_label_next: "Continue",
        button_label_previous: "Go Back",
        show_clickable_nav: true
      }
    
    
      // add the instructions trials to the timeline
      timeline.push(instructionsTrial)
      

      // create the stimulus presentation trial structure
      var fixationCross = {
      	type: jsPsychHtmlKeyboardResponse,
	    stimulus: '+',
	    choices: "NO_KEYS",
	    trial_duration: 500
	  }
	  var stimulusTrial = {
	    type: jsPsychImageKeyboardResponse,
	    stimulus: 'img-1.png',
	    choices: "NO_KEYS",
	    stimulus_width: 250,
	    trial_duration: 2500
	  }
	  var feedbackTrial = {
		type: jsPsychHtmlKeyboardResponse,
	    stimulus: 'The correct response to this stimulus is: h<br><hr>Please press h to proced.',
	    choices: ["h"],
      }

      // combine the three trial types into a single structure (trainingProcedure)
      var trainingProcedure = {
		timeline: [fixationCross, stimulusTrial, feedbackTrial],
		repetitions: 3
	  }

	  // and push the trainingProcedure into the main timeline
	  timeline.push(trainingProcedure)

      // run the experiment
      jsPsych.run(timeline);

    </script>
  </body>

</html>
```


## Conditional trials

Sometimes we want to be able to control whether a block of trials is part of the timeline or not. For example, suppose our experiment has two treatment conditions. Participants in the **Training** condition (`1`) complete the `trainingProcedure`, while participants in the **No Training** condition (`0`) do not complete the `trainingProcedure`.

JsPsych has a way to handle this kind of *Conditional* behavior, by adding a conditional function to the grouping object (sometimes called a `node` in the experiment). Here's how that could look:

```js

// set the condition to No Feedback (= 0)
var participant_condition = 0

var trainingProcedure = {
	timeline: [fixationCross, stimulusTrial, feedbackTrial],
	repetitions: 3,
	conditional_function: function () {
		if (participant_condition == 1) {
			return true
		} else {
			return false
		}
	}
}
```